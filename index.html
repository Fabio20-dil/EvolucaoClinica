<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Evolução Terapêutica + Questionário ABA</title>
  <style>
    :root {
      --bg: #0b0f14;
      --card: #111823;
      --muted: #9bb0c3;
      --text: #e6eef6;
      --accent: #5cc8ff;
      --danger: #ff6b6b;
      --ok: #25d366;
      --radius: 14px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      background: linear-gradient(180deg, #071019, #0b0f14 40%);
      color: var(--text);
    }
    header {
      padding: 28px 18px;
      border-bottom: 1px solid #1d2733;
      background: rgba(17,24,35,.6);
      backdrop-filter: blur(6px);
      position: sticky; top: 0; z-index: 10;
    }
    .wrap { max-width: 980px; margin: 0 auto; padding: 24px 18px 80px; }
    h1 { font-size: 1.6rem; margin: 0 0 4px; letter-spacing: .2px; }
    p.lead { margin: 4px 0 0; color: var(--muted); }

    .card {
      background: var(--card); border: 1px solid #1b2532; border-radius: var(--radius);
      padding: 18px; margin: 18px 0; box-shadow: 0 6px 22px rgba(0,0,0,.35);
    }
    .grid { display: grid; gap: 14px; }
    .grid.cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        @media (max-width: 800px) {
  
  /* 1. Faz o header deixar de ser fixo e rolar com a página */
  header {
    position: static; /* <-- A MUDANÇA PRINCIPAL */
    backdrop-filter: none; /* Desativa o blur para performance */
    text-align: center; /* Opcional: centraliza o título no celular */
  }

  /* 2. Faz a barra de botões (toolbar) deixar de ser fixa */
  .toolbar {
    position: static; /* <-- A MUDANÇA PRINCIPAL */
    backdrop-filter: none;
    margin-top: 24px; /* Adiciona um espaço antes dos botões */
    border-radius: var(--radius); /* Opcional: deixa mais bonito */
  }

  /* 3. Empilha a barra de botões (CSV/PDF em cima, Enviar embaixo) */
  .toolbar .row {
    flex-direction: column;
    gap: 12px;
    align-items: stretch; /* Faz os botões ocuparem 100% */
  }

  .toolbar .row button {
    width: 100%;
    justify-content: center;
  }
  
  /* 4. Empilha as colunas principais (Nome, Email, Paciente, etc.) */
  .grid.cols-2 { 
    grid-template-columns: 1fr; 
  }
  
  /* 5. Empilha o questionário ABA (pergunta em cima, input embaixo) */
  .percent-group {
    grid-template-columns: 1fr;
    gap: 4px;
  }

  /* 6. Diminui as margens laterais para caber mais */
  .wrap {
    padding-left: 12px;
    padding-right: 12px;
    padding-top: 16px;
  }

  .card {
    padding: 14px;
  }
    }

    fieldset { border: none; padding: 0; margin: 0;margin-inline-start: 0; margin-inline-end: 0; padding-inline-start: 0;padding-inline-end: 0; }
    legend { font-weight: 600; margin-bottom: 10px; }

    label { display: block; font-size: .95rem; margin: 6px 0 6px; color: var(--muted); }

    input[type="text"], input[type="email"], input[type="date"], select, textarea, input[type="number"] {
    color-scheme: dark; /* <--- ADICIONE ESTA LINHA */
    width: 100%; background: #0d141e; color: var(--text); border: 1px solid #223145; border-radius: 10px;
    padding: 10px 12px; outline: none; transition: border .18s ease, box-shadow .18s ease;
    }
    input:focus, select:focus, textarea:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(92,200,255,.15); }

    .help { color: var(--muted); font-size: .85rem; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; }

    .chips { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 8px; justify-content: flex-start; }
    .chip { display: inline-flex; align-items: center; gap: 8px; padding: 8px 10px; border: 1px solid #223145; border-radius: 999px; background: #0d141e; }

    .section-title { font-size: 1.05rem; font-weight: 600; margin: 8px 0 6px; }

    .percent-group { display: grid; grid-template-columns: 1fr 120px; gap: 10px; align-items: center; }
    .percent-group .unit { opacity: .8; font-size: .9rem; }

    .error { color: var(--danger); font-size: .85rem; margin-top: 4px; display: none; }
    .ok { color: var(--ok); font-size: .85rem; margin-top: 4px; display: none; }

    .toolbar { position: sticky; bottom: 0; z-index: 9; padding: 12px 18px; border-top: 1px solid #1d2733; background: rgba(17,24,35,.75); backdrop-filter: blur(6px); }
    .toolbar .row { justify-content: space-between; align-items: center; }

    button {
      all: unset; display: inline-flex; align-items: center; justify-content: center; gap: 8px;
      background: linear-gradient(180deg,#278ed0,#1b6faa); border: 1px solid #1a77b8; color: #eaf5ff;
      padding: 10px 16px; border-radius: 12px; cursor: pointer; font-weight: 600;
      box-shadow: 0 6px 20px rgba(39,142,208,.35);
    }
    button.secondary { background: #0d141e; border-color: #223145; color: var(--text); box-shadow: none; }
    button:disabled { opacity: .6; cursor: not-allowed; }

    .hidden { display: none !important; }

    /* Painel de testes */
    #testPanel { font-size: .9rem; }
    #testPanel ul { margin: 8px 0 0 18px; }
    .pass { color: #8fd19e; }
    .fail { color: #ff8b8b; }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>Evolução Terapêutica + Questionário ABA</h1>
      <p class="lead">Campos em % aceitam apenas <strong>números de 0 a 100</strong> (sem o símbolo %).</p>
    </div>
  </header>

  <main class="wrap">
    <div class="card" style="border-left:4px solid #1b6faa">
      <strong>Controle de acesso</strong>
      <p class="help">Apenas emails de terapeutas cadastrados aparecem na lista. Se o email não estiver cadastrado, o envio é bloqueado e você deve pedir à coordenação para incluir o terapeuta.</p>
    </div>
    <form id="formAba" novalidate>
      <!-- DADOS DA SESSÃO (sempre visíveis) -->
      <section class="card" id="sec-dados">
        <h2 class="section-title">1) Dados da sessão</h2>
        <div class="grid cols-2">
        
        <div>
          <label for="terapeuta">Nome do Terapeuta</label>
          <input list="therapistsList" type="text" id="terapeuta" name="terapeuta" required placeholder="Selecione seu nome..." />
          <datalist id="therapistsList">
            </datalist>
          <div class="help">Comece a digitar e selecione seu nome na lista.</div>
        </div>

        <div>
          <label for="email">Email do terapeuta</label>
          <input type="email" id="email" name="email" required placeholder="nome@exemplo.com" />
          <div class="error" id="err-email">Informe um e-mail válido.</div>
          <div class="help">Será preenchido automaticamente após selecionar o nome.</div>
        </div>

        <div>
          <label for="especialidade">Especialidade do terapeuta</label>
          <select id="especialidade" name="especialidade" required>
            <option value="" selected disabled>Selecione…</option>
            <option>Fonoaudiologia</option>
            <option>Musicoterapia</option>
            <option>Psicologia</option>
            <option>Psicomotricidade</option>
            <option>Psicopedagogia</option>
            <option>Terapia ABA</option>
            <option>Terapia Alimentar</option>
            <option>Terapia Ocupacional</option>
          </select>
        </div>
        <div>
          <label for="paciente">Nome do Paciente</label>
          <input type="text" id="paciente" name="paciente" required />
        </div>
        <div>
          <label for="relatorio">Paciente recebeu o relatório</label>
          <select id="relatorio" name="relatorio" required>
            <option value="" selected disabled>Selecione…</option>
            <option>Sim</option>
            <option>Não</option>
          </select>
        </div>
        <div>
          <label for="data">Data da sessão</label>
          <input type="date" id="data" name="data" required />
        </div>
      </div>

        <div class="grid cols-2" style="margin-top:14px">
          <div>
            <label>Comparecimento</label>
            <div class="chips" role="radiogroup" aria-label="Comparecimento">
              <label class="chip"><input type="radio" name="comparecimento" value="Compareceu" required /> Compareceu</label>
              <label class="chip"><input type="radio" name="comparecimento" value="Faltou" required /> Faltou</label>
            </div>
            <div class="help">Se marcar "Faltou", as seções da sessão serão ocultadas e aparecerá um formulário específico de falta.</div>
          </div>
        </div>
      </section>

      <!-- FLUXO NORMAL (apenas quando Compareceu) -->
      <section class="card flow-normal" id="sec-checklists">
        <h2 class="section-title">2) Checklists da sessão</h2>
        <fieldset>
          <legend>Estado de saúde (como a criança chegou)</legend>
          <div class="chips">
            <label class="chip"><input type="checkbox" name="estado_saude" value="Ativo(a)" /> Ativo(a)</label>
            <label class="chip"><input type="checkbox" name="estado_saude" value="Tranquilo(a)" /> Tranquilo(a)</label>
            <label class="chip"><input type="checkbox" name="estado_saude" value="Sonolento(a)" /> Sonolento(a)</label>
            <label class="chip"><input type="checkbox" name="estado_saude" value="Irritado(a)" /> Irritado(a)</label>
            <label class="chip"><input type="checkbox" name="estado_saude" value="Agitado(a)" /> Agitado(a)</label>
            <label class="chip"><input type="checkbox" name="estado_saude" value="Devagarinho(a)" /> Devagarinho(a)</label>
            <label class="chip"><input type="checkbox" name="estado_saude" value="Cooperativo(a)" /> Cooperativo(a)</label>
            <label class="chip"><input type="checkbox" name="estado_saude" value="Não cooperativo(a)" /> Não cooperativo(a)</label>
          </div>
        </fieldset>

        <fieldset style="margin-top:12px">
          <legend>Conduta Terapêutica</legend>
          <div class="chips">
            <label class="chip"><input type="checkbox" name="conduta" value="Concentração / Foco" /> Concentração / Foco</label>
            <label class="chip"><input type="checkbox" name="conduta" value="Memória" /> Memória</label>
            <label class="chip"><input type="checkbox" name="conduta" value="Atenção" /> Atenção</label>
            <label class="chip"><input type="checkbox" name="conduta" value="Percepção auditiva" /> Percepção auditiva</label>
            <label class="chip"><input type="checkbox" name="conduta" value="Percepção visual" /> Percepção visual</label>
            <label class="chip"><input type="checkbox" name="conduta" value="Percepção Espacial" /> Percepção Espacial</label>
            <label class="chip"><input type="checkbox" name="conduta" value="Percepção temporal" /> Percepção temporal</label>
            <label class="chip"><input type="checkbox" name="conduta" value="Linguagem" /> Linguagem</label>
            <label class="chip"><input type="checkbox" name="conduta" value="Funções executivas" /> Funções executivas</label>
            <label class="chip"><input type="checkbox" name="conduta" value="Flexibilidade cognitiva" /> Flexibilidade cognitiva</label>
            <label class="chip"><input type="checkbox" name="conduta" value="Capacidade criativa" /> Capacidade criativa</label>
            <label class="chip"><input type="checkbox" name="conduta" value="Brincar funcional" /> Brincar funcional</label>
            <label class="chip"><input type="checkbox" name="conduta" value="Habilidades motoras" /> Habilidades motoras</label>
            <label class="chip"><input type="checkbox" name="conduta" value="Motricidade fina" /> Motricidade fina</label>
            <label class="chip"><input type="checkbox" name="conduta" value="Habilidade social" /> Habilidade social</label>
            <label class="chip"><input type="checkbox" name="conduta" value="Outras Habilidades" /> Outras Habilidades</label>
          </div>
        </fieldset>

        <fieldset style="margin-top:12px">
          <legend>Observações / Intercorrência</legend>
          <div class="chips">
            <label class="chip"><input type="checkbox" name="intercorrencia" value="Sem intercorrências" /> Sem intercorrências</label>
            <label class="chip"><input type="checkbox" name="intercorrencia" value="Quadro alérgico" /> Quadro alérgico</label>
            <label class="chip"><input type="checkbox" name="intercorrencia" value="Hedema" /> Hedema</label>
            <label class="chip"><input type="checkbox" name="intercorrencia" value="Caiu no chão" /> Caiu no chão</label>
            <label class="chip"><input type="checkbox" name="intercorrencia" value="Necessário chamar o responsável" /> Necessário chamar o responsável</label>
          </div>
        </fieldset>

        <fieldset style="margin-top:12px">
          <legend>Conclusão da terapia</legend>
          <div class="chips">
            <label class="chip"><input type="checkbox" name="conclusao_terapia" value="Concluiu sem intercorrência" /> Concluiu sem intercorrência</label>
            <label class="chip"><input type="checkbox" name="conclusao_terapia" value="Concluiu com suporte total" /> Com suporte total</label>
            <label class="chip"><input type="checkbox" name="conclusao_terapia" value="Concluiu com suporte parcial" /> Com suporte parcial</label>
            <label class="chip"><input type="checkbox" name="conclusao_terapia" value="Ficou irritado(a)" /> Ficou irritado(a)</label>
            <label class="chip"><input type="checkbox" name="conclusao_terapia" value="Ficou chateado(a)" /> Ficou chateado(a)</label>
          </div>
        </fieldset>

        <div style="margin-top:12px">
          <label for="obs">Observações</label>
          <textarea id="obs" name="obs" rows="3" placeholder="Opcional"></textarea>
        </div>
      </section>

      <!-- QUESTIONÁRIO ABA (PERCENTUAIS) -->
      <section class="card flow-normal" id="sec-aba">
        <h2 class="section-title">3) Questionário – ABA (percentuais 0–100)</h2>
        <p class="help">Digite apenas números (sem %). Exemplos: 5, 20, 90, 50, 100.</p>

        <!-- Grupo 1 -->
        <h3 class="section-title">1. Habilidades básicas / Atenção</h3>
        <div class="grid">
          <div class="percent-group">
            <label for="aten_hab">Habilidade de atenção (%)</label>
            <input class="pct" id="aten_hab" name="aten_hab" type="number" inputmode="numeric" min="0" max="100" step="1" required />
          </div>
          <div class="percent-group">
            <label for="aten_cv">Mantém contato visual breve (%)</label>
            <input class="pct" id="aten_cv" name="aten_cv" type="number" inputmode="numeric" min="0" max="100" step="1" required />
          </div>
          <div class="percent-group">
            <label for="aten_nome">Responde ao próprio nome (%)</label>
            <input class="pct" id="aten_nome" name="aten_nome" type="number" inputmode="numeric" min="0" max="100" step="1" required />
          </div>
          <div class="percent-group">
            <label for="aten_instr">Segue instruções simples (%)</label>
            <input class="pct" id="aten_instr" name="aten_instr" type="number" inputmode="numeric" min="0" max="100" step="1" required />
          </div>
        </div>

        <!-- Grupo 2 -->
        <h3 class="section-title" style="margin-top:14px">2. Habilidade de Comunicação</h3>
        <div class="grid">
          <div class="percent-group">
            <label for="com_sons">Emite sons vocais (%)</label>
            <input class="pct" id="com_sons" name="com_sons" type="number" inputmode="numeric" min="0" max="100" step="1" required />
          </div>
          <div class="percent-group">
            <label for="com_gestos">Usa gestos para se comunicar (aponta, mostra) (%)</label>
            <input class="pct" id="com_gestos" name="com_gestos" type="number" inputmode="numeric" min="0" max="100" step="1" required />
          </div>
          <div class="percent-group">
            <label for="com_imita">Imita sons ou palavras (%)</label>
            <input class="pct" id="com_imita" name="com_imita" type="number" inputmode="numeric" min="0" max="100" step="1" required />
          </div>
          <div class="percent-group">
            <label for="com_nomeia">Nomeia objetos e pessoas (%)</label>
            <input class="pct" id="com_nomeia" name="com_nomeia" type="number" inputmode="numeric" min="0" max="100" step="1" required />
          </div>
          <div class="percent-group">
            <label for="com_pede">Faz pedido simples (%)</label>
            <input class="pct" id="com_pede" name="com_pede" type="number" inputmode="numeric" min="0" max="100" step="1" required />
          </div>
        </div>

        <!-- Grupo 3 (mais grupos podem ser adicionados) -->
        <h3 class="section-title" style="margin-top:14px">3. Interação social</h3>
        <div class="grid">
          <div class="percent-group">
            <label for="soc_sorri">Sorri em resposta a estímulos sociais (%)</label>
            <input class="pct" id="soc_sorri" name="soc_sorri" type="number" min="0" max="100" step="1" required />
          </div>
          <div class="percent-group">
            <label for="soc_prox">Aceita proximidade de outras crianças (%)</label>
            <input class="pct" id="soc_prox" name="soc_prox" type="number" min="0" max="100" step="1" required />
          </div>
          <div class="percent-group">
            <label for="soc_jogos">Participa de jogos simples (%)</label>
            <input class="pct" id="soc_jogos" name="soc_jogos" type="number" min="0" max="100" step="1" required />
          </div>
          <div class="percent-group">
            <label for="soc_comp">Compartilha brinquedos ou materiais (%)</label>
            <input class="pct" id="soc_comp" name="soc_comp" type="number" min="0" max="100" step="1" required />
          </div>
          <div class="percent-group">
            <label for="soc_inicia">Inicia interações com adultos ou pares (%)</label>
            <input class="pct" id="soc_inicia" name="soc_inicia" type="number" min="0" max="100" step="1" required />
          </div>
        </div>

      <!-- Grupo 4 (mais grupos podem ser adicionados) -->
        <h3 class="section-title" style="margin-top:14px">4. Habilidade Cognitivas</h3>
        <div class="grid">
          <div class="percent-group">
            <label for="cog_reconhece">Reconhece cores, formas e tamanhos (%)</label>
            <input class="pct" id="cog_reconhece" name="cog_reconhece" type="number" min="0" max="100" step="1" required />
          </div>
          <div class="percent-group">
            <label for="cog_associa">Associa objetos semelhantes (%)</label>
            <input class="pct" id="cog_associa" name="cog_associa" type="number" min="0" max="100" step="1" required />
          </div>
          <div class="percent-group">
            <label for="cog_identifica">Identifica partes do corpo (%)</label>
            <input class="pct" id="cog_identifica" name="cog_identifica" type="number" min="0" max="100" step="1" required />
          </div>
          <div class="percent-group">
            <label for="cog_corresp">Faz correspondência de figuras iguais (%)</label>
            <input class="pct" id="cog_corresp" name="cog_corresp" type="number" min="0" max="100" step="1" required />
          </div>
          <div class="percent-group">
            <label for="cog_executa">Executa sequência simples(ex.: colocar blocos um sobre o outro) (%)</label>
            <input class="pct" id="cog_executa" name="cog_executa" type="number" min="0" max="100" step="1" required />
          </div>
        </div>

      <!-- Grupo 5 (mais grupos podem ser adicionados) -->
        <h3 class="section-title" style="margin-top:14px">5. Habilidade de Motricidade Grossa</h3>
        <div class="grid">
          <div class="percent-group">
            <label for="motGro_senta">Senta-se sem apoio (%)</label>
            <input class="pct" id="motGro_senta" name="motGro_senta" type="number" min="0" max="100" step="1" required />
          </div>
          <div class="percent-group">
            <label for="motGro_anda">Anda sem ajuda (%)</label>
            <input class="pct" id="motGro_anda" name="motGro_anda" type="number" min="0" max="100" step="1" required />
          </div>
          <div class="percent-group">
            <label for="motGro_corre">Corre com equilíbrio (%)</label>
            <input class="pct" id="motGro_corre" name="motGro_corre" type="number" min="0" max="100" step="1" required />
          </div>
          <div class="percent-group">
            <label for="motGro_sobe">Sobe e desce degraus (%)</label>
            <input class="pct" id="motGro_sobe" name="motGro_sobe" type="number" min="0" max="100" step="1" required />
          </div>
          <div class="percent-group">
            <label for="motGro_chuta">Chuta ou arremessa bola (%)</label>
            <input class="pct" id="motGro_chuta" name="motGro_chuta" type="number" min="0" max="100" step="1" required />
          </div>
        </div>

      <!-- Grupo 6 (mais grupos podem ser adicionados) -->
        <h3 class="section-title" style="margin-top:14px">6. Habilidade de Motricidade Fina</h3>
        <div class="grid">
          <div class="percent-group">
            <label for="motFina_pega">Pega objetos pequenos com pinça (%)</label>
            <input class="pct" id="motFina_pega" name="motFina_pega" type="number" min="0" max="100" step="1" required />
          </div>
          <div class="percent-group">
            <label for="motFina_rabisca">Rabisca com lápis ou giz (%)</label>
            <input class="pct" id="motFina_rabisca" name="motFina_rabisca" type="number" min="0" max="100" step="1" required />
          </div>
          <div class="percent-group">
            <label for="motFina_encaixa">Encaixa peças simples (%)</label>
            <input class="pct" id="motFina_encaixa" name="motFina_encaixa" type="number" min="0" max="100" step="1" required />
          </div>
          <div class="percent-group">
            <label for="motFina_virapeca">Vira peças simples (%)</label>
            <input class="pct" id="motFina_virapeca" name="motFina_virapeca" type="number" min="0" max="100" step="1" required />
          </div>
          <div class="percent-group">
            <label for="motFina_virapag">Vira páginas de livros (%)</label>
            <input class="pct" id="motFina_virapag" name="motFina_virapag" type="number" min="0" max="100" step="1" required />
          </div>
          <div class="percent-group">
            <label for="motFina_talheres">Usa talheres com supervisão (%)</label>
            <input class="pct" id="motFina_talheres" name="motFina_talheres" type="number" min="0" max="100" step="1" required />
          </div>
        </div>

      <!-- Grupo 7 (mais grupos podem ser adicionados) -->
        <h3 class="section-title" style="margin-top:14px">7. Habilidade de Autonomia</h3>
        <div class="grid">
          <div class="percent-group">
            <label for="auto_levaObj">Leva objetos até o adulto quando solicitado (%)</label>
            <input class="pct" id="auto_levaObj" name="auto_levaObj" type="number" min="0" max="100" step="1" required />
          </div>
          <div class="percent-group">
            <label for="auto_colsapato">Tira e coloca sapatos com ajuda (%)</label>
            <input class="pct" id="auto_colsapato" name="auto_colsapato" type="number" min="0" max="100" step="1" required />
          </div>
          <div class="percent-group">
            <label for="auto_comeSoz">Come sozinho com colher (%)</label>
            <input class="pct" id="auto_comeSoz" name="auto_comeSoz" type="number" min="0" max="100" step="1" required />
          </div>
          <div class="percent-group">
            <label for="auto_LavaEseca">Lava e seca as mãos com supervisão (%)</label>
            <input class="pct" id="auto_LavaEseca" name="auto_LavaEseca" type="number" min="0" max="100" step="1" required />
          </div>
          <div class="percent-group">
            <label for="auto_guarda">Guarda brinquedos após o uso (%)</label>
            <input class="pct" id="auto_guarda" name="auto_guarda" type="number" min="0" max="100" step="1" required />
          </div>
        </div>
      </section>

      <section class="card flow-normal" id="sec-revisao">
        <h2 class="section-title">4) Revisão</h2>
        <p class="help">Verifique os campos. Campos em % só aceitam 0–100. Se "Faltou" foi selecionado, as seções serão ocultadas e aparecerá o formulário de falta.</p>
      </section>

      <!-- FORMULÁRIO ALTERNATIVO - MOTIVO DA FALTA (apenas quando Faltou) -->
      <section class="card hidden flow-falta" id="sec-falta">
        <h2 class="section-title">Motivo da falta</h2>
        <div class="grid">
          <div>
            <label for="motivo_falta">Selecione o motivo</label>
            <select id="motivo_falta" name="motivo_falta">
              <option value="" selected disabled>Selecione…</option>
              <option>Sem justificativa</option>
              <option>Troca de agenda ou horário</option>
              <option>Motivo por doença</option>
              <option>Problemas pessoais</option>
            </select>
          </div>
          <div>
            <label for="obs_falta">Observação (opcional)</label>
            <textarea id="obs_falta" name="obs_falta" rows="3" placeholder="Escreva detalhes, se necessário..."></textarea>
          </div>
        </div>
      </section>

      <div class="toolbar">
        <div class="row" style="justify-content: flex-end;"> 
            <div class="row" style="gap:10px">
                <button type="submit" id="btnSubmit">Enviar</button>
            </div>
        </div>
        </div>
    </form>

    <div id="toast" class="card hidden" role="status" aria-live="polite"></div>

  </main>

  <script>
    
    
// ===== Lista de terapeutas (AGORA VAZIA, SERÁ PREENCHIDA DA PLANILHA) =====
    let THERAPISTS_LIST = []; 
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxqON8d3zRK-pAgatoeFEm3XCC-jcGVYwWGSgsjIg1m-CHUWQscoDq_sKYR1yIm-dvHPw/exec"; // COLE A SUA URL AQUI

    // --- Declarações de variáveis ---
    const form = document.getElementById('formAba');
    const toast = document.getElementById('toast');
    const secABA = document.getElementById('sec-aba');
    const selectEsp = document.getElementById('especialidade');
    const emailInput = document.getElementById('email');
    const nameInput  = document.getElementById('terapeuta');
    const datalist   = document.getElementById('therapistsList');
    const flowNormals = document.querySelectorAll('.flow-normal');
    const secFalta = document.getElementById('sec-falta');

    // --- Preenche datalist de emails autorizados (Agora usa a lista global) ---
    function populateTherapistsDatalist() {
    if (!datalist) return;
    datalist.innerHTML = '';
    THERAPISTS_LIST.forEach(t => {
        const opt = document.createElement('option');
        opt.value = t.name; // <-- MUDANÇA PRINCIPAL AQUI
        // Opcional: o label pode mostrar o email no dropdown em alguns navegadores
        opt.label = t.email; 
        datalist.appendChild(opt);
    });
    }

    // --- Procura na lista global ---
    function findTherapistByName(name) {
    if (!name) return null;
    const v = String(name).trim().toLowerCase();
    // Encontra pelo nome
    return THERAPISTS_LIST.find(t => t.name.toLowerCase() === v) || null;
    }

    function syncTherapistEmailFromName() {
    // Usa a nova função de busca
    const t = findTherapistByName(nameInput.value); 
    if (t) {
        emailInput.value = t.email; // Preenche o email
        emailInput.readOnly = true;
        emailInput.classList.remove('invalid');
    } else {
        emailInput.readOnly = false; // Permite digitar
    }
    }

    // --- Sanitização de percentuais ---
    function sanitizePercentInput(el) {
      el.value = el.value.replace(/%/g, '').trim();
      if (el.value === '') return;
      const n = Number(el.value);
      if (Number.isNaN(n)) { el.value = ''; return; }
      el.value = String(Math.trunc(n));
      let m = Number(el.value);
      if (m < 0) m = 0;
      if (m > 100) m = 100;
      el.value = String(m);
    }

    document.querySelectorAll('input.pct').forEach(inp => {
      inp.addEventListener('input', e => sanitizePercentInput(e.target));
      inp.addEventListener('blur', e => sanitizePercentInput(e.target));
      inp.setAttribute('pattern', '^([0-9]{1,2}|100)$');
      inp.setAttribute('title', 'Digite apenas números de 0 a 100');
    });

    // --- Visibilidade dos fluxos Compareceu/Faltou e da seção ABA ---
    function updateFormVisibility() {
      const fd = new FormData(form);
      const comp = fd.get('comparecimento');
      const compareceu = comp === 'Compareceu';
      const faltou = comp === 'Faltou';
      const espABA = selectEsp && selectEsp.value === 'Terapia ABA';

      // Fluxo normal (2, 3, 4) só quando Compareceu
      flowNormals.forEach(sec => sec.classList.toggle('hidden', !compareceu));

      // Formulário de falta só quando Faltou
      secFalta.classList.toggle('hidden', !faltou);

      // ABA só se Compareceu E especialidade = Terapia ABA
      secABA.classList.toggle('hidden', !(compareceu && espABA));
      document.querySelectorAll('#sec-aba input.pct').forEach(inp => {
        inp.required = compareceu && espABA;
        inp.disabled = !(compareceu && espABA);
        if (!(compareceu && espABA)) inp.value = '';
      });
    }

    // --- Listeners de mudança e estado inicial ---
    form.addEventListener('change', e => {
      if (e.target.name === 'comparecimento') updateFormVisibility();
      if (e.target === nameInput) syncTherapistEmailFromName();
      if (e.target === selectEsp) updateFormVisibility();
    });
    if (selectEsp) {
      selectEsp.addEventListener('change', updateFormVisibility);
    }
    populateTherapistsDatalist();
    syncTherapistEmailFromName();
    updateFormVisibility();

    function showToast(msg) {
      toast.textContent = msg;
      toast.classList.remove('hidden');
      setTimeout(() => toast.classList.add('hidden'), 2200);
    }


    // 
    // ===================================================================
    // == ESTA É A FUNÇÃO DE SUBMIT CORRETA (SÓ PODE TER UMA!) ==
    // ===================================================================
    //
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const ther = findTherapistByName(nameInput.value); 
        if (!ther) {
        showToast('Nome de terapeuta não cadastrado. Selecione um nome válido da lista.');
        nameInput.focus(); // Foca no campo de NOME
        return;
        }
        emailInput.value = ther.email;
      
      if (!form.reportValidity()) {
        showToast('Verifique os campos destacados.');
        return;
      }

      const btn = document.getElementById('btnSubmit');
      btn.disabled = true;
      btn.textContent = 'Enviando...';
      showToast('Enviando para o Google Sheets...');

      const formData = new FormData(form);
      const dataPayload = {};
      const keys = new Set([...formData.keys()]);
      
      keys.forEach(key => {
        const values = formData.getAll(key);
        dataPayload[key] = values.length > 1 ? values.join('; ') : values[0];
      });
      dataPayload['terapeuta'] = ther.name;
      
      // ASSEGURE-SE QUE A URL ESTÁ CORRETA AQUI
      if (SCRIPT_URL === "COLE_A_SUA_URL_DO_APPS_SCRIPT_AQUI") {
        showToast('ERRO: A URL do Script não foi configurada no HTML.');
        btn.disabled = false;
        btn.textContent = 'Enviar';
        return;
      }
      
      try {
        const response = await fetch(SCRIPT_URL, {
          method: 'POST',
          mode: 'no-cors', 
          cache: 'no-cache',
          redirect: 'follow',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(dataPayload) 
        });
        
        showToast('Evolução enviada com sucesso!');
        form.reset(); 
        setTimeout(updateFormVisibility, 50); 
        // Não precisa repopular a lista, ela não mudou
  
      } catch (error) {
        console.error('Erro ao enviar:', error);
        showToast('ERRO: Não foi possível enviar. Tente novamente.');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Enviar';
      }
    });


// --- NOVA FUNÇÃO PARA CARREGAR OS TERAPEUTAS ---
    // Busca a lista de terapeutas na planilha ao carregar a página
    async function loadTherapists() {
      // Mostra um status inicial
      emailInput.placeholder = "Carregando terapeutas...";
      emailInput.disabled = true;
      
      if (SCRIPT_URL === "COLE_A_SUA_URL_DO_APPS_SCRIPT_AQUI") {
        showToast('ERRO: A URL do Script não foi configurada no HTML.');
        return;
      }

      try {
        // O 'fetch' para a mesma URL, mas sem 'POST', vira um 'GET'
        const response = await fetch(SCRIPT_URL);
        if (!response.ok) {
          throw new Error(`Falha na rede: ${response.statusText}`);
        }
        const data = await response.json();
        
        if (data.error) {
          throw new Error(`Erro do Script: ${data.error}`);
        }
        
        THERAPISTS_LIST = data; // Preenche a lista global
        populateTherapistsDatalist(); // Agora, preenche o <datalist>
        
        emailInput.placeholder = "nome@exemplo.com";
        emailInput.disabled = false;
      
      } catch (error) {
        console.error('Erro ao carregar lista de Terapeutas:', error);
        showToast('ERRO: Não foi possível carregar a lista de terapeutas.');
        emailInput.placeholder = "Erro ao carregar lista";
      }
    }

    // --- INICIALIZAÇÃO ---
    // Estado inicial dos formulários
    updateFormVisibility(); 
    // Carrega a lista de terapeutas da planilha
    loadTherapists();

  </script>
</body>
</html>